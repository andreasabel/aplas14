# Makefile for contnorm

destdir=$(HOME)/public_html

# commands
bibtool=bibtool -- 'preserve.key.case = ON' \
	  -- 'check.double = ON' \
	  -- 'check.double.delete = ON' \
	  -- 'delete.field = { editor }' \
	  -- 'delete.field = { abstract }' \
	  -- 'delete.field = { dvi }' \
	  -- 'delete.field = { postscript }' \
	  -- 'delete.field = { pdf }' \
	  -- 'delete.field = { month }' \
	  -- 'delete.field = { isbn }'
#	  -- 'delete.field = { doi }'
catcfg=sed -e "s/%.*//g" <
pdflatex=pdflatex
# pdflatex=xelatex
stdlib=$(HOME)/agda-master/std-lib/src

bibliography=medium.bib
sedfile=postprocess.sed

stylefile=latex/agda.sty

# TeX files generated by Agda
generatedfiles=InfiniteTypes.tex Terms.tex \
  Subst0.tex Rename.tex NContexts.tex NReduction.tex sn-definition.tex \
  TermShape.tex SN.tex IndRen.tex AntiRename.tex SAT.tex \
  Soundness.tex SNtosn.tex AgdaExamples.tex TypeEquality.tex \
  ECxtList.tex SNtosnR.tex SNtosn2.tex
# Agda files
lagdafiles=$(patsubst %.tex,%.lagda,$(generatedfiles))

# All dependencies
files=byhand.bib macros.tex intro.tex types.tex syntax.tex red.tex strongnormalization.tex soundnessproof.tex SNcorrectness.tex examples.tex concl.tex $(generatedfiles) $(stylefile)

allfiles=Makefile aplas14.tex aplas14.bbl auto-aplas14.bib $(files) $(lagdafiles)

.PRECIOUS : %.tex latex/%.tex aplas14.pdf aplas14long.pdf

default : aplas14.pdf aplas14long.pdf

all : default ship

ship : $(destdir)/aplas14long.pdf $(destdir)/aplas14.pdf $(destdir)/aplas14.zip

$(destdir)/%.pdf : %.pdf
	cp -p $< $@

$(destdir)/%.zip : %.zip
	cp -p $< $@

pack : aplas14.zip

aplas14.zip : $(allfiles)
	zip $@ $^

# aplas14
##################################################################

%.tex : latex/%.tex $(sedfile)
	sed --file=$(sedfile) < $< > $@

latex/%.tex : %.lagda
	agda --latex -i. -i$(stdlib) $< +RTS -M1.5g -RTS

# aplas14.pdf : aplas14.lagda
#	pdflatex $<

# initially, run latex once to create an .aux file
# mark .aux file as fresh by creating a stamp _aux
aplas14long_aux : aplas14long.tex $(files)
	-$(pdflatex) aplas14long.tex;
	touch $@;

# # initially, run latex once to create an .aux file
# # mark .aux file as fresh by creating a stamp _aux
aplas14_aux : aplas14.tex $(files)
	-$(pdflatex) aplas14.tex;
	touch $@;

# then, run bibtex
aplas14.bbl : aplas14_aux auto-aplas14.bib
	-bibtex aplas14;

aplas14long.bbl : aplas14long_aux auto-aplas14.bib
	-bibtex aplas14long;

# finally, finish by running latex twice again
# this will update .aux, but leave the stamp _aux intact
# (otherwise we would not converge and make would never
# return a "Nothing to do")
aplas14.pdf : aplas14.bbl
	-$(pdflatex) aplas14.tex;
	$(pdflatex) aplas14.tex;

aplas14long.pdf : aplas14long.bbl
	-$(pdflatex) aplas14long.tex;
	$(pdflatex) aplas14long.tex;

# auto-aplas14.bib is only defined if bibtool is present and all.bib exists

ifneq ($(shell which bibtool),)
ifneq ($(shell ls $(bibliography)),)
auto-aplas14.bib : aplas14long_aux $(bibliography)
	echo "%%%% WARNING! AUTOMATICALLY CREATED BIBFILE" > $@;
	echo "%%%% DO NOT EDIT! ALL CHANGES WILL BE LOST!" >> $@ ;
	echo "" >> $@ ;
	$(bibtool) -x aplas14long.aux -i $(bibliography) >> $@;
endif
endif

clean :
	-rm $(generatedfiles)

cleaner :
	-rm $(generatedfiles)
	-cd latex; rm $(generatedfiles); cd ..



# EOF
